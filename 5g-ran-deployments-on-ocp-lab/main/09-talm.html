<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Topology Aware Lifecycle Manager (TALM) :: LAB - 5G RAN Deployments on OpenShift</title>
    <link rel="canonical" href="https://pages.sysdeseng.com/5g-ran-deployments-on-ocp-lab/5g-ran-deployments-on-ocp-lab/main/09-talm.html">
    <link rel="prev" href="07-managing-at-scale.html">
    <link rel="next" href="10-policygen-deepdive.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://pages.sysdeseng.com/5g-ran-deployments-on-ocp-lab">LAB - 5G RAN Deployments on OpenShift</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="5g-ran-deployments-on-ocp-lab" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="00-introduction.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-introduction.html#lab-aim">Who is this lab aimed at? </a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="00-introduction.html#lab-software-versions">Lab Software Versions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-5g-ran-context.html">5G Ran Context</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#low-latency">Low Latency</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#numa-nodes">NUMA Nodes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#huge-pages">Huge Pages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#cpu-pinning">CPU Pinning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#irq-load-balancing">IRQ Load Balancing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#dpdk">DPDK</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#oot-drivers">OoT Drivers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#cpu-reduction-tuning">Tuning for CPU Reduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#vran-accelerators">vRAN Dedicated Accelerators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-5g-ran-context.html#ptp">PTP</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-sno-intro.html">Introduction to Single Node OpenShift (SNO)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-sno-intro.html#5g-ran">5G Radio Access Network</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-sno-intro.html#things-keep-mind">Things to keep in mind</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-sno-intro.html#deployments">Deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-sno-intro.html#extra-information">Extra information</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-cnf-operators-intro.html">Introduction to CNF Operators</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-cnf-operators-intro.html#node-tuning-operator">Node Tuning Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-cnf-operators-intro.html#sriov-operator">SR-IOV Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-cnf-operators-intro.html#ptp-operator">PTP Operator</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-cnf-operators-intro.html#accelerators-operators">Accelerators Operators</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-ztp-intro.html">Introduction to Zero Touch Provisioning (ZTP)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-ocp-gitops.html">OpenShift GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-ocp-gitops.html#gitops">GitOps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-ocp-gitops.html#gitops-principles">GitOps Principles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-ocp-gitops.html#gitops-patterns-ocp">GitOps Patterns on OpenShift</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-ocp-gitops.html#directories-vs-branches">Directories vs Branches</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-ocp-gitops.html#direct-commit-to-main">Direct commit to main</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="05-ocp-gitops.html#prs-review-cycles">Pull Requests and review cycles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-ocp-gitops.html#gitops-ocp">GitOps on OpenShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-ztp-at-scale.html">ZTP Components</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-ztp-at-scale.html#rhacm">Red Hat Advanced Cluster Management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-ztp-at-scale.html#mce">Multicluster Engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-ztp-at-scale.html#ai">Infrastructure Operator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-ztp-at-scale.html#gitops-operator">GitOps Operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-ztp-at-scale.html#sitegen">SiteGen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="08-ztp-at-scale.html#policygen">PolicyGen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="08-ztp-at-scale.html#talm">Topology Aware Lifecycle Manager</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="21-ztp-workflow.html">ZTP Workflow</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-rhacm-policies.html">RHACM Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-rhacm-policies.html#policy-framework">Policy Framework</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-rhacm-policies.html#policies">Policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-rhacm-policies.html#policy-status">Policy Status</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-rhacm-policies.html#policy-remediation">Policy Remediation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-managing-at-scale.html">Managing at Scale</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-managing-at-scale.html#inform-policies">Inform Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-managing-at-scale.html#olm-subscriptions">OLM Subscriptions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-managing-at-scale.html#cluster-policies">Cluster Policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-talm.html">Topology Aware Lifecycle Manager (TALM)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#inform-policies">Default Inform Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cgu">Cluster Group Upgrade</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#autocreation-cgu">Auto Creation of CGUs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#phase-labels">Phase labels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#waves">Policy Waves</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#talm-precache">Precaching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#talm-backup">Backup &amp; Recovery</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-policygen-deepdive.html">PolicyGen Deepdive</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-policygen-deepdive.html#policygen-implementation">PolicyGen Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-policygen-deepdive.html#kustomize-plugins">Kustomize Plugins</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#siteconfig-generator">SiteConfigGenerator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#policy-generator">Policy Generator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="10-policygen-deepdive.html#5g-ran-profile">5G RAN Profile</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#workload-partitioning">Workload Partitioning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#kubelet-tuning">Kubelet Tuning</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#sctp">SCTP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#hide-container-mount">Container Mount Hiding</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#recovery-optimization">Recovery Optimization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#monitoring-footprint">Monitoring Operator Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#ocp-console">Console Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#networking-diags">Networking Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#operatorhub">OperatorHub</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#ptp-operator">PTP Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#sr-iov">SR-IOV</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#nto">Node Tuning Operator</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#local-storage">Local Storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="10-policygen-deepdive.html#logs">Log Collector and Forwarder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-policygen-deepdive.html#siteconfig-templating">SiteConfig Templating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-policygen-deepdive.html#policies-templating">Policies Templating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-policygen-deepdive.html#kustomize-plugins-locally">Running Kustomize Plugins Locally</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-deployment-considerations.html">Deployment Considerations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-deployment-considerations.html#hardware-configurations">Hardware configurations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-deployment-considerations.html#bios-settings">Bios Settings</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-deployment-considerations.html#networking">Networking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="11-deployment-considerations.html#disconnected-environments">Disconnected Environments</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-deployment-considerations.html#connected-proxy">Connected through proxy</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="11-deployment-considerations.html#fully-disconnected">Fully disconnected</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-deployment-considerations.html#git-repo-structure">Git Repository Structure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="22-lab-environment.html">Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="23-lab-environment-introduction.html">Introduction to the Lab Environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="12-crafting-deployments-iaac.html">Crafting Deployment&#8217;s IaaC</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="13-crafting-cluster-cnf-operators-configs.html">Crafting Cluster and CNF Operators Configs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-running-the-deployment.html">Running the Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-monitoring-the-deployment.html">Monitoring the Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="16-check-deployment-is-finished.html">Check Deployment is finished</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="17-using-talm-to-update-clusters.html">Using TALM to update clusters</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="18-troubleshooting-tips.html">Troubleshooting Tips</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="19-common-pitfalls.html">Common Pitfalls</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19-common-pitfalls.html#exec-probes-cpu-pinning">Exec Probes and CPU Pinning</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19-common-pitfalls.html#energy-saving-hw-profiles">Energy Saving Hardware Profiles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19-common-pitfalls.html#secure-boot-oot-unsigned-drivers">Secure Boot and Unsigned OoT Drivers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19-common-pitfalls.html#sriov-node-drain">SR-IOV Node Drain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="19-common-pitfalls.html#pod-disruption-budgets">Pod Disruption Budgets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="20-closing-thoughts.html">Closing Thoughts</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">LAB - 5G RAN Deployments on OpenShift</a></li>
    <li><a href="09-talm.html">Topology Aware Lifecycle Manager (TALM)</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RHsyseng/5g-ran-deployments-on-ocp-lab/edit/main/documentation/modules/ROOT/pages/09-talm.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Topology Aware Lifecycle Manager (TALM)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Leveraging TALM we can manage the lifecycle of thousands of clusters at scale, this is required when working on complex RAN environments.</p>
</div>
<div class="paragraph">
<p>Remember that ZTP generates installation and configuration resources from manifests (<code>siteConfig</code> and <code>policyGenTemplates</code>) stored in Git. These artifacts are applied to a centralized hub cluster where a combination of OpenShift GitOps, Red Hat Advanced Cluster Management, the Assisted Service which is deployed by the Infrastructure Operator, and the Topology Aware Lifecycle Manager (TALM) use them to install and configure the cluster. See <a href="08-ztp-at-scale.html">ZTP components</a> chapter.</p>
</div>
<div class="paragraph">
<p>The configuration phase of this ZTP process depends on TALM to orchestrate the application of the configuration custom resources to the cluster. There are several key integration points between GitOps ZTP and TALM.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inform-policies"><a class="anchor" href="#inform-policies"></a>Default inform policies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ZTP, as mentioned in the <a href="07-managing-at-scale.html#inform-policies">Managing at scale</a> section, will create all policies with a remediation action of "inform". With this remediation action Red Hat ACM will notice the compliance state of the policy but will not take any action to apply the desired configuration. However, this is not always our preferred choice. Most of the times we want a configuration to be actually applied to our managed clusters.</p>
</div>
<div class="paragraph">
<p>In these events, TALM will step through the set of created policies and switch them to an "enforce" policy in order to push configuration to the spoke cluster. This strategy ensures that ZTP integrates seamlessly with future configuration changes that need to be made without the risk of rolling those changes out to all spoke clusters in the network simultaneously.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
TALM enables us to select the timing and the clusters where the configuration is about to be applied.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cgu"><a class="anchor" href="#cgu"></a>Cluster Group Upgrade (CGU)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Topology Aware Lifecycle Manager (TALM) builds the remediation plan from the <code>ClusterGroupUpgrade</code> CR for a group of clusters. You can define the following specifications in a ClusterGroupUpgrade CR. Note that this is a CGU CR that enforces a OpenShift release upgrade which was previously defined by a policy called <em>du-upgrade-platform-upgrade</em> defined by the managedPolicies spec.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: ocp411-3
  namespace: ztp-group-du-sno
spec:
  preCaching: true #precache enabled before upgrade
  backup: true  #backup enabled before upgrade
  deleteObjectsOnCompletion: false
  clusters:   #Clusters in the group
  - snonode-virt02
  - snonode-virt01
  - snonode-virt03
  enable: true
  managedPolicies:
  - du-upgrade-platform-upgrade #Applicable list of managed policies
  remediationStrategy:
    canaries:
      - snonode-virt01 #Defines the clusters for canary updates
    maxConcurrency: 2 #Defines the maximum number of concurrent updates in a batch
    timeout: 240</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="autocreation-cgu"><a class="anchor" href="#autocreation-cgu"></a>Auto creation of CGU</h3>
<div class="paragraph">
<p>So far we have been talking of using TALM for our common day-2 operations. But, if a CGU must be created in order to enforce a previously applied policy,  how is it possible to run a fully automated ZTP workflow, e.g configure and even run our CNF workloads, on the target clusters?</p>
</div>
<div class="paragraph">
<p>The answer is that TALM interacts with ZTP for newly created clusters. When we define one or multiple spoke clusters in telco, we do not only want to provision them, we also want to apply an specific configuration such as the validated <a href="10-policygen-deepdive#5g-ran-profile">5G RAN DU profile</a>. Often we also want our workloads to be running on top of them. ZTP is envisioned as a streamlined process, where as a developer we only push manifest definitions to the proper Git repository.</p>
</div>
<div class="paragraph">
<p>So, once clusters are provisioned, TALM monitors their state by checking the ManagedCluster CRs on the hub cluster. Any ManagedCluster CR which does not have a <strong>"ztp-done"</strong> label applied, including newly created ManagedCluster CRs, will cause TALM to automatically create a ClusterGroupUpgrade CR with the following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is created in the ztp-install namespace</p>
</li>
<li>
<p>It has the same name as the ManagedCluster CR, usually the name of the cluster.</p>
</li>
<li>
<p>The cluster selector includes only the cluster associated with that ManagedCluster CR</p>
</li>
<li>
<p>The set of managedPolicies includes <strong>ALL</strong> policies that ACM has bound to the cluster at the time the CGU is created.</p>
</li>
<li>
<p>It is enabled</p>
</li>
<li>
<p>Precaching is disabled</p>
</li>
<li>
<p>Timeout set to 4 hours (240 minutes)</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
TALM will basically enforce all existing policies targeting a cluster that has not the label "ztp-done'. This is performed by creating automatically a proper CGU CR.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="phase-labels"><a class="anchor" href="#phase-labels"></a>Phase labels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ClusterGroupUpgrade CR that is auto created for ZTP includes directives to annotate the ManagedCluster CR with labels at the start and end of the ZTP process. When ZTP configuration (post-installation) commences the ManagedCluster will have the ztp-running label applied. When all policies are remediated to the cluster (fully compliant) these directives will cause TALM to remove the ztp-running label and apply the ztp-done label.</p>
</div>
<div class="paragraph">
<p>In essence, the ztp-done label will be applied when the cluster is fully ready for deployment of applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="waves"><a class="anchor" href="#waves"></a>Waves</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A ZTP wave is basically an annotation (ran.openshift.io/ztp-deploy-wave) included on each policy template that will permit TALM to apply policies in an ordered manner. As an example, every <a href="10-policygen-deepdive#policies-templating">policy</a> generated from a PolicyGenTemplate by ZTP incorporates a wave number such as the <a href="https://github.com/openshift-kni/cnf-features-deploy/blob/master/ztp/source-crs/SriovSubscriptionNS.yaml">SriovSubscriptionNS.yaml</a>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Namespace
metadata:
  name: openshift-sriov-network-operator
  annotations:
    workload.openshift.io/allowed: management
    ran.openshift.io/ztp-deploy-wave: "2"</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Detailed information on policy templates can be found in the following <a href="10-policygen-deepdive#policies-templating">PolicyGen deepdive</a> section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TALO will apply the configuration policies in the order specified by the wave annotations and will wait for each policy to be compliant before moving to the next policy. It is important to ensure that the wave annotation for each CR takes into account any pre-requisites for those CRs to be applied to the cluster. For example an operator must be installed before, or concurrently with, the configuration for the operator.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
All CRs in the same policy must have the same setting for the ztp-deploy-wave annotation. The default value of this annotation for each CR can be overridden in the PolicyGenTemplate.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="talm-precache"><a class="anchor" href="#talm-precache"></a>Precaching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clusters might have limited bandwidth to access the container image registry, which can cause a timeout before the updates are completed. This feature help us to schedule cluster upgrades to newer OCP releases in an organized manner and within the maintenance window assigned. Notice in the following picture how the upgrade can be orchestrated depending on our requirements. See that in the first maintenance window not all clusters had time to precache all container images, then the precache process was postponed to a be finished in another agreed maintenance window. Finally, a new maintenance window was requested to actually execute the platform upgrade.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/talm_precache.png" alt="ACM architecture">
</div>
</div>
<div class="paragraph">
<p>By enabling precache feature and disable the CGU, as shown in the following code snippet, the first thing is going to happen is pull all the container images required for the OCP release we are about to upgrade in the target cluster. So, we will have all required images already downloaded in our container-storage location before even starting the upgrade task.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-41018
  namespace: ztp-group-du-sno
spec:
  preCaching: true #precache configuration
  backup: true
  deleteObjectsOnCompletion: true
  clusters:
  - cnfdb1
  - cnfdb2
  enable: false #precache only
  managedPolicies:
  - du-upgrade-platform-upgrade
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the container images are precached, we can just enable the CGU by setting <code>enabled: true</code>. Then a regular platform upgrade managed by the TALM operator will start. This time the installation will be faster since the bits are now stored in the local disk.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If both policy and precaching are enabled, the upgrade will be executed immediately after the precache is done successfully.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A more in-detail explanation of the Backup &amp; Recovery is covered in this <a href="https://videos.learning.redhat.com/media/OCP+TALO+precache+sequential+platform+upgrade/1_7kgh6jze/253048913">training material</a> "Precaching and sequential platform upgrades using TALM".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="talm-backup"><a class="anchor" href="#talm-backup"></a>Backup and Recovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Backup &amp; Recovery feature creates a pre-upgrade backup and provides a procedure for rapid recovery of a SNO in the event of a failed upgrade. In case of an upgrade failure, this feature allows the SNO to be restored to a working state with the previous version of OCP without requiring a re-provision of the application(s).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Backup &amp; Recovery currently only targets Single Node OpenShift clusters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Backup workload is a one-shot task created on each of the spoke cluster nodes to trigger backup and keep the backup and system resources in the recovery partition in order to recovery a failed upgrade. For SNO spokes it is realized as a batch/v1 job.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is highly recommended to create a recovery partition at install time if opted to use this feature.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Below we can see the same CGU shown in the previous section, but this time the CGU is enabled. So, if the CGU and backup specs are enabled, then backup task is executed prior to the platform upgrade. If the backup finishes successfully, the upgrade task is started.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: ran.openshift.io/v1alpha1
kind: ClusterGroupUpgrade
metadata:
  name: du-upgrade-41018
  namespace: ztp-group-du-sno
spec:
  preCaching: true #precache was done
  backup: true #backup feature enabled
  deleteObjectsOnCompletion: true
  clusters:
  - cnfdb1
  - cnfdb2
  enable: true #backup is triggered when CGU is enabled
  managedPolicies:
  - du-upgrade-platform-upgrade
  remediationStrategy:
    maxConcurrency: 2
    timeout: 240</code></pre>
</div>
</div>
<div class="paragraph">
<p>The backup workload generates an utility called upgrade-recovery.sh in the recovery partition or at the recovery folder at <code>/var/recovery</code> and takes the pre-upgrade backup. In addition, the active OS deployment is pinned using ostree and the standby deployments are removed.</p>
</div>
<div class="paragraph">
<p>In case, the upgrade failed in a spoke cluster, the TALM CGU needs to be deleted in the hub cluster and an admin needs to login to the spoke cluster to start the recovery process. The process is detailed in the <a href="https://github.com/openshift-kni/cluster-group-upgrades-operator/tree/main/docs/backup-recovery#recovery-from-upgrade-failure">Recovery from Upgrade failure</a> documentation.</p>
</div>
<div class="paragraph">
<p>A more in-detail explanation of the Backup &amp; Recovery is covered in this <a href="https://videos.learning.redhat.com/media/Upgrade%2C+backup+and+recovery+with+TALO/1_27k8gb8m/253048913">training material</a> "Upgrade, backup and recover your cluster with TALM".</p>
</div>
<div class="paragraph">
<p>[1] You can read more about it <a href="https://docs.openshift.com/container-platform/latest/scalability_and_performance/cnf-talm-for-cluster-upgrades.html">here</a>.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="07-managing-at-scale.html">Managing at Scale</a></span>
  <span class="next"><a href="10-policygen-deepdive.html">PolicyGen Deepdive</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
